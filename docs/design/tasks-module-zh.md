# Tasks æ¨¡å— - éœ€æ±‚ä¸è®¾è®¡æ–‡æ¡£

> ç‰ˆæœ¬ï¼š1.0
> æ—¥æœŸï¼š2026-02-23
> çŠ¶æ€ï¼šè‰ç¨¿
> èŒƒå›´ï¼šTask List Tab + åç«¯ tasks æ¨¡å— + task-worker æœåŠ¡ + æ–‡æ¡£ç³»ç»Ÿ

---

## 1. æ¦‚è¿°

Tasks æ¨¡å—æ˜¯ Team9 å¹³å°çš„ AI Staffï¼ˆBotï¼‰ä»»åŠ¡ç®¡ç†ç³»ç»Ÿã€‚ç”¨æˆ·å¯ä»¥ä¸º Bot åˆ›å»ºä¸€æ¬¡æ€§æˆ–å‘¨æœŸæ€§ä»»åŠ¡ï¼ŒBot è‡ªä¸»æ‰§è¡Œä»»åŠ¡å¹¶å®æ—¶æ±‡æŠ¥è¿›åº¦ï¼Œæœ€ç»ˆäº¤ä»˜æˆæœã€‚ç”¨æˆ·å¯ä»¥ç›‘æ§æ‰§è¡Œè¿‡ç¨‹ã€åœ¨éœ€è¦æ—¶è¿›è¡Œå¹²é¢„ã€æŸ¥çœ‹äº¤ä»˜ç‰©ã€‚

æ¯ä¸ª Botï¼ˆç›®å‰åº•å±‚ç”± OpenClaw é©±åŠ¨ï¼‰åœ¨ UI ä¸­æ‹¥æœ‰ä¸€ä¸ªã€ŒTask Listã€Tabï¼Œä¸ Messages ç­‰ Tab å¹¶åˆ—ã€‚æ­¤å¤–ï¼Œç³»ç»Ÿè¿˜æä¾›ä¸€ä¸ªç‹¬ç«‹çš„ã€ŒTasksã€é¡µé¢ï¼ˆä¸ AI Staff / Apps åŒçº§ï¼‰ï¼Œç”¨äºè·¨ Bot ç»Ÿä¸€ç®¡ç†å’ŒæŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡ã€‚

## 2. æ ¸å¿ƒæ¦‚å¿µ

| æ¦‚å¿µ                           | è¯´æ˜                                                                                        |
| ------------------------------ | ------------------------------------------------------------------------------------------- |
| **Taskï¼ˆä»»åŠ¡ï¼‰**               | åˆ†é…ç»™æŸä¸ª Bot æ‰§è¡Œçš„å·¥ä½œå•å…ƒï¼Œæ‹¥æœ‰å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸ                                           |
| **Task Executionï¼ˆæ‰§è¡Œè®°å½•ï¼‰** | ä»»åŠ¡çš„ä¸€æ¬¡è¿è¡Œï¼ˆç‰ˆæœ¬ï¼‰ã€‚å‘¨æœŸæ€§ä»»åŠ¡ä¼šç”Ÿæˆå¤šæ¡æ‰§è¡Œè®°å½•                                        |
| **Task Stepï¼ˆä»»åŠ¡æ­¥éª¤ï¼‰**      | æ‰§è¡Œè¿‡ç¨‹ä¸­çš„å­æ­¥éª¤ï¼Œç”± Bot è‡ªåŠ¨åˆ›å»ºå’Œæ¨è¿›                                                   |
| **Task Channelï¼ˆä»»åŠ¡é¢‘é“ï¼‰**   | æ¯æ¬¡æ‰§è¡Œä¸“å±çš„è™šæ‹Ÿ IM é¢‘é“ï¼ˆæ–°å¢ `task` é¢‘é“ç±»å‹ï¼‰ï¼Œç”¨äºè¯¥æ¬¡ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡ä¸­çš„ç”¨æˆ·-Bot é€šä¿¡ |
| **Documentï¼ˆæ–‡æ¡£ï¼‰**           | é™„åŠ åœ¨ä»»åŠ¡ä¸Šçš„ç‰ˆæœ¬åŒ– Markdown æ–‡æ¡£ï¼Œä¸º Agent æä¾›è¯¦ç»†çš„ä»»åŠ¡è¯´æ˜                             |
| **Deliverableï¼ˆäº¤ä»˜ç‰©ï¼‰**      | ä»»åŠ¡æ‰§è¡Œäº§å‡ºçš„æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€docxã€pptx ç­‰ï¼‰                                                   |
| **Interventionï¼ˆäººå·¥å¹²é¢„ï¼‰**   | Bot åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”¨æˆ·å‘èµ·çš„å®¡æ‰¹/ç¡®è®¤è¯·æ±‚                                                   |

## 3. ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ upcoming â”‚  ï¼ˆå‘¨æœŸä»»åŠ¡ï¼šç­‰å¾…è°ƒåº¦ / ä¸€æ¬¡æ€§ä»»åŠ¡ï¼šç­‰å¾…æ‰‹åŠ¨å¯åŠ¨ï¼‰
                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                         â”‚ è§¦å‘ / è°ƒåº¦è§¦å‘
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”Œâ”€â”€â”€â”€ â”‚ in_progress  â”‚ â—„â”€â”€â”€â”€ æ¢å¤ï¼ˆresumeï¼‰
           â”‚     â””â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”˜
           â”‚        â”‚   â”‚   â”‚
      éœ€è¦äººå·¥è¾“å…¥   â”‚   â”‚   â”‚ æš‚åœï¼ˆpauseï¼‰
           â”‚        â”‚   â”‚   â–¼
           â–¼        â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚ â”‚ paused â”‚ â”€â”€ æ¢å¤ â”€â”€â†’ in_progress
   â”‚pending_actionâ”‚ â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
          â”‚ ç”¨æˆ·å“åº”  â”‚   â”‚ åœæ­¢ / é”™è¯¯ / è¶…æ—¶
          â””â”€â”€â–º â”€â”€â”€â”€â”€â”€â”˜   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ completed    â”‚â”€â”€â†’ é‡æ–°æ‰§è¡Œï¼ˆrestartï¼‰â”€â”€â†’ æ–°æ‰§è¡Œè®°å½•
                    â”‚ failed       â”‚
                    â”‚ stopped      â”‚
                    â”‚ timeout      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€æšä¸¾

| çŠ¶æ€             | è¯´æ˜                             |
| ---------------- | -------------------------------- |
| `upcoming`       | ç­‰å¾…æ‰§è¡Œï¼ˆå·²è°ƒåº¦æˆ–ç­‰å¾…æ‰‹åŠ¨è§¦å‘ï¼‰ |
| `in_progress`    | Bot æ­£åœ¨æ‰§è¡Œä¸­                   |
| `paused`         | è¢«ç”¨æˆ·æš‚åœ                       |
| `pending_action` | Bot æ­£åœ¨ç­‰å¾…äººå·¥å¹²é¢„             |
| `completed`      | æ‰§è¡ŒæˆåŠŸå®Œæˆ                     |
| `failed`         | æ‰§è¡Œå‡ºé”™ç»“æŸ                     |
| `stopped`        | è¢«ç”¨æˆ·æ‰‹åŠ¨ç»ˆæ­¢                   |
| `timeout`        | è¶…å‡ºè¶…æ—¶é™åˆ¶                     |

### å„çŠ¶æ€ä¸‹å…è®¸çš„ç”¨æˆ·æ“ä½œ

| å½“å‰çŠ¶æ€         | å…è®¸çš„æ“ä½œ                 |
| ---------------- | -------------------------- |
| `upcoming`       | å¯åŠ¨ã€ç¼–è¾‘ã€åˆ é™¤           |
| `in_progress`    | åœæ­¢ã€æš‚åœã€ç¼–è¾‘ï¼ˆå‘æ¶ˆæ¯ï¼‰ |
| `paused`         | å¯åŠ¨ï¼ˆæ¢å¤ï¼‰ã€åœæ­¢ã€ç¼–è¾‘   |
| `pending_action` | å“åº”å¹²é¢„è¯·æ±‚ã€åœæ­¢         |
| `completed`      | é‡æ–°æ‰§è¡Œã€æŸ¥çœ‹äº¤ä»˜ç‰©       |
| `failed`         | é‡æ–°æ‰§è¡Œã€æŸ¥çœ‹é”™è¯¯è¯¦æƒ…     |
| `stopped`        | é‡æ–°æ‰§è¡Œ                   |
| `timeout`        | é‡æ–°æ‰§è¡Œ                   |

## 4. ç³»ç»Ÿæ¶æ„

```
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   Clientï¼ˆUIï¼‰    â”‚
                          â”‚  Task List Tab    â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                               â”‚ REST   â”‚ WebSocket (Socket.io)
                               â–¼        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚     Gateway      â”‚
                          â”‚  tasks æ¨¡å—      â”‚
                          â”‚  documents æ¨¡å—  â”‚
                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     RabbitMQ  â”‚        â”‚ DB / Redis
                               â–¼        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  task-worker â”‚â—„â”€â”€â”€â”€â–ºâ”‚  PostgreSQL  â”‚   â”‚  Redis   â”‚
â”‚  ï¼ˆæ–°æœåŠ¡ï¼‰    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTPï¼ˆOpenClaw APIï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenClaw   â”‚
â”‚   å®ä¾‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„ç»„ä»¶èŒè´£

**Gatewayï¼ˆtasks æ¨¡å—ï¼‰**

- æä¾›ä»»åŠ¡ CRUDã€æ§åˆ¶ã€æŸ¥è¯¢çš„ REST API
- æä¾› Bot ä¾§ APIï¼Œç”¨äºçŠ¶æ€æ±‡æŠ¥ã€æ­¥éª¤æ›´æ–°ã€å¹²é¢„è¯·æ±‚ã€äº¤ä»˜ç‰©ä¸Šä¼ 
- é€šè¿‡ WebSocket å¹¿æ’­äº‹ä»¶ï¼Œå®ç° UI å®æ—¶æ›´æ–°
- æ–‡æ¡£ç®¡ç† API

**task-workerï¼ˆæ–°æœåŠ¡ï¼‰**

- å‘¨æœŸä»»åŠ¡è°ƒåº¦å™¨ï¼šæ‰«æ `nextRunAt` æ¥è§¦å‘æ‰§è¡Œ
- æ‰§è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼šåˆ›å»ºæ‰§è¡Œè®°å½•ã€åˆ›å»ºä»»åŠ¡é¢‘é“ã€è§¦å‘ OpenClaw
- è¶…æ—¶æ£€æµ‹ï¼šå®šæœŸæ‰«æè¶…æ—¶çš„æ‰§è¡Œè®°å½•
- RabbitMQ æ¶ˆè´¹è€…ï¼šå¤„ç†æ¥è‡ª Gateway çš„å‘½ä»¤ï¼ˆå¯åŠ¨ã€æš‚åœã€åœæ­¢ç­‰ï¼‰

**OpenClaw é›†æˆ**

- Bot ç±»å‹ä¸º `openclaw` â†’ å°†æ‰§è¡Œå§”æ‰˜ç»™ OpenClaw Agent
- Agent é€šè¿‡ Bot APIï¼ˆaccess token è®¤è¯ï¼‰æ±‡æŠ¥è¿›åº¦
- æœªæ¥ï¼šå…¶ä»– Bot ç±»å‹å¯å®ç°ä¸åŒçš„æ‰§è¡Œç­–ç•¥

## 5. æ•°æ®æ¨¡å‹

### 5.1 `task_tasks` - ä»»åŠ¡ä¸»è¡¨

```sql
CREATE TABLE task_tasks (
    id              UUID PRIMARY KEY,
    tenant_id       UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    bot_id          UUID NOT NULL REFERENCES im_bots(id) ON DELETE CASCADE,
    creator_id      UUID NOT NULL REFERENCES im_users(id),
    title           VARCHAR(500) NOT NULL,
    description     TEXT,                          -- ç®€è¦æè¿°ï¼ˆä¸æ–‡æ¡£åˆ†å¼€ï¼‰
    status          task_status NOT NULL DEFAULT 'upcoming',
    schedule_type   task_schedule_type NOT NULL DEFAULT 'once',  -- 'once' | 'recurring'
    schedule_config JSONB,                         -- { frequency: 'daily', time: '09:00', timezone: 'Asia/Shanghai' } æˆ– cron
    next_run_at     TIMESTAMP,                     -- ä¸‹æ¬¡è®¡åˆ’æ‰§è¡Œæ—¶é—´ï¼ˆä¾› task-worker æ‰«æï¼‰
    document_id     UUID REFERENCES documents(id), -- å…³è”çš„ä»»åŠ¡æ–‡æ¡£
    current_execution_id UUID,                     -- æŒ‡å‘å½“å‰/æœ€æ–°æ‰§è¡Œè®°å½•ï¼ˆåèŒƒå¼åŒ–ï¼ŒåŠ é€ŸæŸ¥è¯¢ï¼‰
    created_at      TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_task_tasks_tenant_id ON task_tasks(tenant_id);
CREATE INDEX idx_task_tasks_bot_id ON task_tasks(bot_id);
CREATE INDEX idx_task_tasks_creator_id ON task_tasks(creator_id);
CREATE INDEX idx_task_tasks_status ON task_tasks(status);
CREATE INDEX idx_task_tasks_next_run_at ON task_tasks(next_run_at);
CREATE INDEX idx_task_tasks_tenant_status ON task_tasks(tenant_id, status);
```

**æšä¸¾ç±»å‹ï¼š**

```sql
CREATE TYPE task_status AS ENUM (
    'upcoming', 'in_progress', 'paused', 'pending_action',
    'completed', 'failed', 'stopped', 'timeout'
);

CREATE TYPE task_schedule_type AS ENUM ('once', 'recurring');
```

### 5.2 `task_executions` - æ‰§è¡Œè®°å½•ï¼ˆç‰ˆæœ¬ï¼‰

æ¯æ¬¡è§¦å‘ï¼ˆæ‰‹åŠ¨æˆ–è°ƒåº¦ï¼‰ä¼šåˆ›å»ºä¸€æ¡æ‰§è¡Œè®°å½•ï¼Œå¹¶å…³è”ä¸€ä¸ªä¸“å±ä»»åŠ¡é¢‘é“ã€‚

```sql
CREATE TABLE task_executions (
    id              UUID PRIMARY KEY,
    task_id         UUID NOT NULL REFERENCES task_tasks(id) ON DELETE CASCADE,
    version         INTEGER NOT NULL,              -- æ‰§è¡Œç‰ˆæœ¬å·ï¼ˆ1, 2, 3...ï¼‰
    status          task_status NOT NULL DEFAULT 'in_progress',
    channel_id      UUID REFERENCES im_channels(id), -- æœ¬æ¬¡æ‰§è¡Œçš„ä¸“å±è™šæ‹Ÿé¢‘é“
    token_usage     INTEGER NOT NULL DEFAULT 0,
    started_at      TIMESTAMP,
    completed_at    TIMESTAMP,
    duration        INTEGER,                       -- ç§’
    error           JSONB,                         -- å¤±è´¥æ—¶çš„é”™è¯¯è¯¦æƒ…
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_task_executions_task_id ON task_executions(task_id);
CREATE INDEX idx_task_executions_status ON task_executions(status);
CREATE INDEX idx_task_executions_task_version ON task_executions(task_id, version);
```

### 5.3 `task_steps` - æ‰§è¡Œæ­¥éª¤

```sql
CREATE TABLE task_steps (
    id              UUID PRIMARY KEY,
    execution_id    UUID NOT NULL REFERENCES task_executions(id) ON DELETE CASCADE,
    task_id         UUID NOT NULL REFERENCES task_tasks(id) ON DELETE CASCADE,  -- åèŒƒå¼åŒ–
    order_index     INTEGER NOT NULL,
    title           VARCHAR(500) NOT NULL,
    status          task_step_status NOT NULL DEFAULT 'pending',
    token_usage     INTEGER NOT NULL DEFAULT 0,
    duration        INTEGER,                       -- ç§’
    started_at      TIMESTAMP,
    completed_at    TIMESTAMP,
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TYPE task_step_status AS ENUM ('pending', 'in_progress', 'completed', 'failed');

CREATE INDEX idx_task_steps_execution_id ON task_steps(execution_id);
CREATE INDEX idx_task_steps_task_id ON task_steps(task_id);
```

### 5.4 `task_deliverables` - äº¤ä»˜ç‰©

```sql
CREATE TABLE task_deliverables (
    id              UUID PRIMARY KEY,
    execution_id    UUID NOT NULL REFERENCES task_executions(id) ON DELETE CASCADE,
    task_id         UUID NOT NULL REFERENCES task_tasks(id) ON DELETE CASCADE,  -- åèŒƒå¼åŒ–
    file_name       VARCHAR(500) NOT NULL,
    file_size       BIGINT,                        -- å­—èŠ‚
    mime_type       VARCHAR(128),
    file_url        TEXT NOT NULL,                  -- å­˜å‚¨ URL
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_task_deliverables_execution_id ON task_deliverables(execution_id);
CREATE INDEX idx_task_deliverables_task_id ON task_deliverables(task_id);
```

### 5.5 `task_interventions` - äººå·¥å¹²é¢„è¯·æ±‚

```sql
CREATE TABLE task_interventions (
    id              UUID PRIMARY KEY,
    execution_id    UUID NOT NULL REFERENCES task_executions(id) ON DELETE CASCADE,
    task_id         UUID NOT NULL REFERENCES task_tasks(id) ON DELETE CASCADE,  -- åèŒƒå¼åŒ–
    step_id         UUID REFERENCES task_steps(id),
    prompt          TEXT NOT NULL,                  -- å‘ç”¨æˆ·å±•ç¤ºçš„æç¤ºä¿¡æ¯
    actions         JSONB NOT NULL,                 -- [{ label: string, value: string }]
    response        JSONB,                          -- ç”¨æˆ·çš„å›åº” { action: string, message?: string }
    status          intervention_status NOT NULL DEFAULT 'pending',
    resolved_by     UUID REFERENCES im_users(id),
    resolved_at     TIMESTAMP,
    expires_at      TIMESTAMP,                     -- å¯é€‰è¿‡æœŸæ—¶é—´
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE TYPE intervention_status AS ENUM ('pending', 'resolved', 'expired');

CREATE INDEX idx_task_interventions_execution_id ON task_interventions(execution_id);
CREATE INDEX idx_task_interventions_task_id ON task_interventions(task_id);
CREATE INDEX idx_task_interventions_status ON task_interventions(status);
```

### 5.6 æ–‡æ¡£ç³»ç»Ÿï¼ˆ`schemas/document/`ï¼‰

ç‹¬ç«‹çš„æ–‡æ¡£ç³»ç»Ÿï¼Œæ”¯æŒå®Œæ•´çš„ç‰ˆæœ¬å†å²ã€‚

**`documents` - æ–‡æ¡£ä¸»è¡¨**

```sql
CREATE TABLE documents (
    id                  UUID PRIMARY KEY,
    tenant_id           UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    owner_type          VARCHAR(64) NOT NULL,          -- 'task' | 'bot' | ...ï¼ˆå¯æ‰©å±•ï¼‰
    owner_id            UUID NOT NULL,                  -- å¤šæ€å¤–é”®
    title               VARCHAR(500),
    current_version_id  UUID,                           -- æŒ‡å‘æœ€æ–°ç‰ˆæœ¬ï¼ˆåèŒƒå¼åŒ–ï¼‰
    created_by          UUID NOT NULL REFERENCES im_users(id),
    created_at          TIMESTAMP NOT NULL DEFAULT NOW(),
    updated_at          TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_documents_tenant_id ON documents(tenant_id);
CREATE INDEX idx_documents_owner ON documents(owner_type, owner_id);
```

**`document_versions` - ç‰ˆæœ¬å†å²è¡¨**

```sql
CREATE TABLE document_versions (
    id              UUID PRIMARY KEY,
    document_id     UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
    version         INTEGER NOT NULL,              -- æŒ‰æ–‡æ¡£è‡ªå¢çš„ç‰ˆæœ¬å·
    content         TEXT NOT NULL,                  -- Markdown å†…å®¹
    summary         TEXT,                          -- å˜æ›´æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
    updated_by      UUID NOT NULL REFERENCES im_users(id),
    created_at      TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_document_versions_document_id ON document_versions(document_id);
CREATE UNIQUE INDEX idx_document_versions_doc_version ON document_versions(document_id, version);
```

### 5.7 é¢‘é“ç±»å‹æ‰©å±•

æ‰©å±• `im_channels.channel_type` æšä¸¾ï¼š

```sql
ALTER TYPE channel_type ADD VALUE 'task';
```

ä»»åŠ¡é¢‘é“ç‰¹æ€§ï¼š

- æ¯æ¬¡æ‰§è¡Œè‡ªåŠ¨åˆ›å»ºï¼Œç”¨æˆ·ä¸å¯æ‰‹åŠ¨åˆ›å»º
- æˆå‘˜ï¼šä»»åŠ¡åˆ›å»ºè€… + è¢«åˆ†é…çš„ Bot
- åœ¨é¢‘é“åˆ—è¡¨ä¾§è¾¹æ ä¸­éšè—ï¼ˆé€šè¿‡ type != 'task' è¿‡æ»¤ï¼‰
- ä»…é€šè¿‡ä»»åŠ¡è¯¦æƒ…é¢æ¿è®¿é—®

## 6. API è®¾è®¡

### 6.1 ä»»åŠ¡ CRUDï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
POST   /v1/tasks                          åˆ›å»ºä»»åŠ¡
GET    /v1/tasks                          æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨ï¼ˆå‚æ•°ï¼šbotId, tenantId, status, scheduleTypeï¼‰
GET    /v1/tasks/:id                      è·å–ä»»åŠ¡è¯¦æƒ…ï¼ˆåŒ…å«å½“å‰æ‰§è¡Œè®°å½•ã€æ­¥éª¤ã€å¹²é¢„è¯·æ±‚ï¼‰
PATCH  /v1/tasks/:id                      æ›´æ–°ä»»åŠ¡ï¼ˆæ ‡é¢˜ã€æè¿°ã€è°ƒåº¦é…ç½®ï¼‰
DELETE /v1/tasks/:id                      åˆ é™¤ä»»åŠ¡
```

### 6.2 ä»»åŠ¡æ§åˆ¶ï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
POST   /v1/tasks/:id/start               å¯åŠ¨ / è§¦å‘ä»»åŠ¡
POST   /v1/tasks/:id/pause               æš‚åœä»»åŠ¡
POST   /v1/tasks/:id/resume              æ¢å¤ä»»åŠ¡
POST   /v1/tasks/:id/stop                åœæ­¢ä»»åŠ¡
POST   /v1/tasks/:id/restart             é‡æ–°æ‰§è¡Œï¼ˆåˆ›å»ºæ–°çš„æ‰§è¡Œè®°å½•ï¼‰
```

### 6.3 æ‰§è¡Œè®°å½•ä¸æ­¥éª¤ï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
GET    /v1/tasks/:id/executions           è·å–ä»»åŠ¡çš„æ‰€æœ‰æ‰§è¡Œè®°å½•
GET    /v1/tasks/:id/executions/:execId   è·å–æŸæ¬¡æ‰§è¡Œè¯¦æƒ…ï¼ˆåŒ…å«æ­¥éª¤ï¼‰
GET    /v1/tasks/:id/executions/:execId/steps   è·å–æŸæ¬¡æ‰§è¡Œçš„æ­¥éª¤åˆ—è¡¨
```

### 6.4 äººå·¥å¹²é¢„ï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
GET    /v1/tasks/:id/interventions        è·å–å¾…å¤„ç†çš„å¹²é¢„è¯·æ±‚åˆ—è¡¨
POST   /v1/tasks/:id/interventions/:intId/resolve   å“åº”å¹²é¢„è¯·æ±‚
```

### 6.5 äº¤ä»˜ç‰©ï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
GET    /v1/tasks/:id/deliverables         è·å–äº¤ä»˜ç‰©åˆ—è¡¨ï¼ˆå¯æŒ‰ executionId ç­›é€‰ï¼‰
```

### 6.6 æ–‡æ¡£ï¼ˆé¢å‘ç”¨æˆ·ï¼ŒJWT è®¤è¯ï¼‰

```
GET    /v1/documents/:id                  è·å–æ–‡æ¡£ï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰
PUT    /v1/documents/:id                  æ›´æ–°æ–‡æ¡£ï¼ˆè‡ªåŠ¨åˆ›å»ºæ–°ç‰ˆæœ¬ï¼‰
GET    /v1/documents/:id/versions         è·å–ç‰ˆæœ¬å†å²åˆ—è¡¨
GET    /v1/documents/:id/versions/:ver    è·å–æŒ‡å®šç‰ˆæœ¬å†…å®¹
```

### 6.7 Bot APIï¼ˆBot Access Token è®¤è¯ï¼‰

è¿™äº›æ¥å£ç”± Botï¼ˆOpenClaw Agentï¼‰è°ƒç”¨ï¼Œç”¨äºæ±‡æŠ¥æ‰§è¡Œè¿›åº¦ã€‚

```
GET    /v1/bot/tasks/pending              è·å–åˆ†é…ç»™è¯¥ Bot çš„å¾…æ‰§è¡Œä»»åŠ¡
GET    /v1/bot/tasks/:id                  è·å–ä»»åŠ¡è¯¦æƒ… + æ–‡æ¡£
PATCH  /v1/bot/tasks/:id/status           æ›´æ–°æ‰§è¡ŒçŠ¶æ€
POST   /v1/bot/tasks/:id/steps            æ±‡æŠ¥æ­¥éª¤è¿›åº¦ï¼ˆåˆ›å»º/æ›´æ–°æ­¥éª¤ï¼‰
POST   /v1/bot/tasks/:id/interventions    å‘èµ·äººå·¥å¹²é¢„è¯·æ±‚
POST   /v1/bot/tasks/:id/deliverables     ä¸Šä¼ äº¤ä»˜ç‰©æ–‡ä»¶
GET    /v1/bot/tasks/:id/document         è·å–ä»»åŠ¡æ–‡æ¡£ï¼ˆä¾› Agent é˜…è¯»ä»»åŠ¡è¯´æ˜ï¼‰
```

**Bot æ­¥éª¤æ±‡æŠ¥è½½è·ï¼š**

```json
{
  "steps": [
    {
      "orderIndex": 1,
      "title": "æ¸…æ´—å¹¶åˆ†æç«å“ç”¨æˆ·è¯„è®ºä¸­çš„æ ¸å¿ƒéœ€æ±‚ç—›ç‚¹",
      "status": "completed",
      "tokenUsage": 248,
      "duration": 72
    },
    {
      "orderIndex": 2,
      "title": "è‡ªåŠ¨æ±‡æ€»å¤šä»½å¸‚åœºæŠ¥å‘Šå¹¶æå–æ ¸å¿ƒè§‚ç‚¹",
      "status": "in_progress"
    }
  ]
}
```

**Bot å¹²é¢„è¯·æ±‚è½½è·ï¼š**

```json
{
  "prompt": "æ˜¯å¦å…è®¸æˆ‘ä»¬è®¿é—®æ‚¨çš„æœåŠ¡å™¨é…ç½®ï¼Ÿ",
  "actions": [
    { "label": "å…è®¸", "value": "allow" },
    { "label": "æ‹’ç»", "value": "deny" }
  ]
}
```

## 7. WebSocket äº‹ä»¶

æ‰€æœ‰äº‹ä»¶çš„ä½œç”¨åŸŸä¸º tenant æˆ¿é—´ï¼ˆå¤ç”¨ç°æœ‰æ¨¡å¼ï¼‰ã€‚

| äº‹ä»¶                          | æ–¹å‘            | è½½è·                                                   |
| ----------------------------- | --------------- | ------------------------------------------------------ |
| `task:status_changed`         | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, status, previousStatus }`      |
| `task:step_updated`           | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, steps: [...] }`                |
| `task:intervention_requested` | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, intervention: {...} }`         |
| `task:intervention_resolved`  | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, interventionId, response }`    |
| `task:deliverable_added`      | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, deliverable: {...} }`          |
| `task:token_usage_updated`    | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, executionId, tokenUsage, stepTokenUsage? }` |
| `task:execution_created`      | æœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ | `{ taskId, execution: {...} }`                         |

## 8. task-worker æœåŠ¡

### 8.1 ç›®å½•ç»“æ„

```
apps/server/apps/task-worker/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.ts                          -- æœåŠ¡å…¥å£ï¼ˆç«¯å£ 3002ï¼‰
â”‚   â”œâ”€â”€ app.module.ts                    -- æ ¹æ¨¡å—
â”‚   â”œâ”€â”€ scheduler/
â”‚   â”‚   â”œâ”€â”€ scheduler.module.ts
â”‚   â”‚   â””â”€â”€ scheduler.service.ts         -- åŸºäºå®šæ—¶çš„å‘¨æœŸä»»åŠ¡è§¦å‘å™¨
â”‚   â”œâ”€â”€ executor/
â”‚   â”‚   â”œâ”€â”€ executor.module.ts
â”‚   â”‚   â”œâ”€â”€ executor.service.ts          -- æ‰§è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â”‚   â””â”€â”€ strategies/
â”‚   â”‚       â”œâ”€â”€ execution-strategy.interface.ts  -- æŠ½è±¡æ‰§è¡Œæ¥å£
â”‚   â”‚       â””â”€â”€ openclaw.strategy.ts     -- OpenClaw ç‰¹å®šæ‰§è¡Œç­–ç•¥
â”‚   â”œâ”€â”€ timeout/
â”‚   â”‚   â”œâ”€â”€ timeout.module.ts
â”‚   â”‚   â””â”€â”€ timeout.service.ts           -- è¶…æ—¶æ£€æµ‹
â”‚   â””â”€â”€ consumer/
â”‚       â”œâ”€â”€ consumer.module.ts
â”‚       â””â”€â”€ task-command.consumer.ts     -- RabbitMQï¼šå¤„ç† å¯åŠ¨/æš‚åœ/åœæ­¢/æ¢å¤ å‘½ä»¤
```

### 8.2 è°ƒåº¦å™¨é€»è¾‘

```
æ¯ 30 ç§’æ‰§è¡Œä¸€æ¬¡ï¼š
  1. SELECT * FROM task_tasks
     WHERE schedule_type = 'recurring'
       AND next_run_at <= NOW()
       AND status NOT IN ('stopped', 'paused')
  2. å¯¹æ¯ä¸ªå‘½ä¸­çš„ä»»åŠ¡ï¼š
     a. åˆ›å»º task_execution è®°å½•ï¼ˆversion = max(version) + 1ï¼‰
     b. åˆ›å»ºä»»åŠ¡é¢‘é“ï¼ˆim_channels type='task'ï¼Œæˆå‘˜ = [åˆ›å»ºè€…, Bot]ï¼‰
     c. é€šè¿‡ OpenClaw API è§¦å‘ Agent æ‰§è¡Œ
     d. æ›´æ–°ä»»åŠ¡ï¼šstatus = 'in_progress', current_execution_id, next_run_at = è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´(scheduleConfig)
```

### 8.3 è¶…æ—¶æ£€æµ‹

```
æ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡ï¼š
  1. SELECT * FROM task_executions
     WHERE status = 'in_progress'
       AND started_at + interval '24 hours' < NOW()   -- å¯æŒ‰ä»»åŠ¡é…ç½®
  2. å¯¹æ¯ä¸ªè¶…æ—¶çš„æ‰§è¡Œè®°å½•ï¼š
     a. æ›´æ–°æ‰§è¡Œè®°å½•ï¼šstatus = 'timeout'
     b. æ›´æ–°çˆ¶ä»»åŠ¡ï¼šstatus = 'timeout'
     c. å‘å‡º WebSocket äº‹ä»¶ï¼štask:status_changed
     d. é€šçŸ¥ OpenClaw åœæ­¢ Agentï¼ˆå¦‚é€‚ç”¨ï¼‰
```

### 8.4 æ‰§è¡Œæµç¨‹

```
è§¦å‘ï¼ˆæ‰‹åŠ¨æˆ–è°ƒåº¦ï¼‰
  â”‚
  â”œâ”€ 1. åˆ›å»º task_execution è®°å½•
  â”œâ”€ 2. åˆ›å»ºä»»åŠ¡é¢‘é“ï¼ˆim_channels type='task'ï¼‰
  â”œâ”€ 3. å°†æˆå‘˜åŠ å…¥é¢‘é“ï¼ˆåˆ›å»ºè€… + Botï¼‰
  â”œâ”€ 4. æ›´æ–° task.status = 'in_progress', task.current_execution_id
  â”œâ”€ 5. è°ƒç”¨ OpenClaw API å¯åŠ¨ Agent
  â”‚     POST {openclaw_url}/api/agents/{agentId}/execute
  â”‚     Body: { taskId, executionId, documentContent, channelId }
  â””â”€ 6. å‘å‡º WebSocket äº‹ä»¶ï¼štask:status_changed, task:execution_created

Agent æ‰§è¡Œä¸­...
  â”‚
  â”œâ”€ Agent è°ƒç”¨ï¼šPATCH /v1/bot/tasks/:id/status â†’ æ›´æ–°è¿›åº¦
  â”œâ”€ Agent è°ƒç”¨ï¼šPOST /v1/bot/tasks/:id/steps â†’ æ±‡æŠ¥æ­¥éª¤å®Œæˆæƒ…å†µ
  â”œâ”€ Agent è°ƒç”¨ï¼šPOST /v1/bot/tasks/:id/interventions â†’ éœ€è¦äººå·¥è¾“å…¥
  â”‚     â†’ ä»»åŠ¡çŠ¶æ€ â†’ pending_action
  â”‚     â†’ WebSocketï¼štask:intervention_requested
  â”‚     â†’ ç”¨æˆ·å“åº” â†’ POST /v1/tasks/:id/interventions/:intId/resolve
  â”‚     â†’ ä»»åŠ¡çŠ¶æ€ â†’ in_progressï¼ˆAgent ç»§ç»­æ‰§è¡Œï¼‰
  â”œâ”€ Agent è°ƒç”¨ï¼šPOST /v1/bot/tasks/:id/deliverables â†’ ä¸Šä¼ æ–‡ä»¶
  â””â”€ Agent è°ƒç”¨ï¼šPATCH /v1/bot/tasks/:id/status { status: 'completed' }
       â†’ WebSocketï¼štask:status_changed
```

## 9. å‰ç«¯è®¾è®¡ï¼ˆåŸºäºè®¾è®¡ç¨¿ï¼‰

### 9.1 å…¥å£

æœ‰ä¸¤ä¸ªå…¥å£ï¼š

1. **Bot è¯¦æƒ…é¡µ Tab**ï¼šTask List æ˜¯ Bot è¯¦æƒ…é¡µå†…çš„ä¸€ä¸ªæ–° Tabï¼Œä¸ Messages å¹¶åˆ—ã€‚ä»…æ˜¾ç¤ºè¯¥ Bot çš„ä»»åŠ¡ã€‚
   - è·¯ç”±ï¼š`/workspace/:tenantId/bot/:botId/tasks`ï¼ˆæˆ–ä½œä¸º Bot è¯¦æƒ…å†…çš„ Tab æ¸²æŸ“ï¼‰

2. **ç‹¬ç«‹ Tasks é¡µé¢**ï¼šä¸ AI Staff / Apps åŒçº§çš„é¡¶å±‚é¡µé¢ï¼Œè·¨ Bot å±•ç¤ºå’Œç®¡ç†æ‰€æœ‰ä»»åŠ¡ã€‚æ”¯æŒæŒ‰ Bot ç­›é€‰ã€‚
   - è·¯ç”±ï¼š`/workspace/:tenantId/tasks`

### 9.2 ä»»åŠ¡åˆ—è¡¨è§†å›¾

**ç­›é€‰ Tabï¼š**

- **In progress**ï¼ˆæ•°é‡ï¼‰â€” æ˜¾ç¤ºçŠ¶æ€ä¸º `in_progress`ã€`paused`ã€`pending_action` çš„ä»»åŠ¡
- **Upcoming**ï¼ˆæ•°é‡ï¼‰â€” æ˜¾ç¤ºçŠ¶æ€ä¸º `upcoming` çš„ä»»åŠ¡
- **Finished**ï¼ˆæ•°é‡ï¼‰â€” æ˜¾ç¤ºçŠ¶æ€ä¸º `completed`ã€`failed`ã€`stopped`ã€`timeout` çš„ä»»åŠ¡

**ä»»åŠ¡å¡ç‰‡ï¼ˆè¿›è¡Œä¸­ï¼‰ï¼š**

```
â— [åŠ è½½åŠ¨ç”»] ä»»åŠ¡æ ‡é¢˜
  å¼€å§‹æ—¶é—´ï¼š2026-01-18 17:54 Â· 2m 17s Â· å·²ç”¨ 248 Tokens
  â†³ å½“å‰æ­¥éª¤æ‘˜è¦æ–‡æœ¬                                    [âŠ˜ åœæ­¢] [âŠ™ æš‚åœ] [âœ ç¼–è¾‘]
```

- `pending_action` çŠ¶æ€çš„ä»»åŠ¡æ˜¾ç¤ºã€Œå¾…å¤„ç†æ“ä½œã€å¾½ç« 
- `paused` çŠ¶æ€çš„ä»»åŠ¡åœ¨å½“å‰æ­¥éª¤ä¸Šæ˜¾ç¤ºã€Œå·²æš‚åœã€å¾½ç« 

**ä»»åŠ¡å¡ç‰‡ï¼ˆå¾…æ‰§è¡Œï¼‰ï¼š**

```
â— ä»»åŠ¡æ ‡é¢˜
  [æ¯å¤©]  é¢„è®¡å¼€å§‹ï¼š2026-01-18 17:54
```

- å‘¨æœŸæ€§ä»»åŠ¡æ˜¾ç¤ºè°ƒåº¦é¢‘ç‡å¾½ç« ï¼ˆæ¯å¤©ã€æ¯å‘¨ ç­‰ï¼‰

**ä»»åŠ¡å¡ç‰‡ï¼ˆå·²å®Œæˆï¼‰ï¼š**

```
â— ä»»åŠ¡æ ‡é¢˜
  å¼€å§‹ï¼š2026-01-18 17:54 Â· ç»“æŸï¼š2026-01-18 17:54 Â· 2m 17s Â· å·²ç”¨ 248 Tokens
  ğŸ“ äº¤ä»˜ 3 ä¸ªæ–‡ä»¶                                              [â†» é‡æ–°æ‰§è¡Œ]
```

- å¦‚æœå‘¨æœŸä»»åŠ¡çš„ä¸‹ä¸€æ¬¡è®¡åˆ’æ‰§è¡Œæ­£åœ¨è¿›è¡Œä¸­ï¼Œæ˜¾ç¤ºã€Œè®¡åˆ’ä»»åŠ¡ï¼šâ— æ‰§è¡Œä¸­ã€

### 9.3 ä»»åŠ¡è¯¦æƒ…é¢æ¿ï¼ˆå³ä¾§æŠ½å±‰ï¼‰

ç‚¹å‡»ä»»åŠ¡å¡ç‰‡å±•å¼€ã€‚å“åº”å¼å¸ƒå±€ï¼š

- å®½å±ï¼šä¸ä»»åŠ¡åˆ—è¡¨å¹¶æ’æ˜¾ç¤º
- çª„å±ï¼šè¦†ç›–å¼é¢æ¿

**å¤´éƒ¨ï¼š**

```
âœ• å…³é—­
ğŸ“‹ åˆ†æ 2025 å¹´ä¼ä¸šçº§ AI å·¥å…·å¸‚åœºè§„æ¨¡ä¸å¢é•¿è¶‹åŠ¿
â— æ‰§è¡Œä¸­ Â· 2m 17s Â· å·²ç”¨ 496 Tokens
```

**ä»»åŠ¡æ­¥éª¤ï¼ˆæ—¶é—´çº¿ï¼‰ï¼š**

```
â”€â”€â”€â”€ ä»»åŠ¡æ­¥éª¤ â”€â”€â”€â”€
âœ… æ¸…æ´—å¹¶åˆ†æç«å“ç”¨æˆ·è¯„è®ºä¸­çš„æ ¸å¿ƒéœ€æ±‚ç—›ç‚¹
   2026-01-18 17:54 Â· 1m 12s Â· å·²ç”¨ 248 Tokens
âœ… è‡ªåŠ¨æ±‡æ€»å¤šä»½å¸‚åœºæŠ¥å‘Šå¹¶æå–æ ¸å¿ƒè§‚ç‚¹
   2026-01-18 17:54 Â· 1m 5s Â· å·²ç”¨ 248 Tokens
â—  ç ”ç©¶è¡Œä¸šæ”¿ç­–å˜åŒ–çš„å½±å“
   ï¼ˆæ‰§è¡Œä¸­...ï¼‰
```

**æš‚åœçŠ¶æ€ï¼š**

```
â„¹ï¸ ä»»åŠ¡æ‰§è¡Œå·²æš‚åœã€‚
   [âŠ™ å¯åŠ¨]
```

**äººå·¥å¹²é¢„ï¼ˆpending_actionï¼‰ï¼š**

```
â—  ç ”ç©¶è¡Œä¸šæ”¿ç­–å˜åŒ–çš„å½±å“
   âš ï¸ æ˜¯å¦å…è®¸æˆ‘ä»¬è®¿é—®æ‚¨çš„æœåŠ¡å™¨é…ç½®ï¼Ÿ
   [æ“ä½œï¼šå…è®¸] [æ“ä½œï¼šæ‹’ç»]
```

**å·²å®Œæˆ - äº¤ä»˜ç‰©ï¼š**

```
â”€â”€â”€â”€ äº¤ä»˜ 3 ä¸ªæ–‡ä»¶ â”€â”€â”€â”€
ğŸ–¼ï¸ xnip2025-07-30.png    1.16MB
ğŸ“„ hello.docx             1.16MB
ğŸ“Š hello.pptx             1.16MB
```

**æ¶ˆæ¯è¾“å…¥æ¡†ï¼ˆåº•éƒ¨ï¼‰ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ B I â‰¡ â‰¡                                â”‚
â”‚ å‘é€æ¶ˆæ¯ä»¥è°ƒæ•´ä»»åŠ¡                        â”‚
â”‚ Aa ğŸ˜Š @ ğŸ“ â†—                        ğŸ”µ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ¶ˆæ¯å‘é€åˆ°è¯¥æ¬¡æ‰§è¡Œçš„ä¸“å±é¢‘é“ï¼ˆim_channels type='task'ï¼‰ã€‚

## 10. è°ƒåº¦é…ç½®

### 10.1 scheduleConfig ç»“æ„

```typescript
interface ScheduleConfig {
  // ç®€å•é¢„è®¾
  frequency?: "daily" | "weekly" | "monthly";
  time?: string; // "09:00"ï¼ˆHH:mmï¼‰
  timezone?: string; // "Asia/Shanghai"
  dayOfWeek?: number; // 0-6ï¼ˆç”¨äºæ¯å‘¨ï¼‰
  dayOfMonth?: number; // 1-31ï¼ˆç”¨äºæ¯æœˆï¼‰

  // é«˜çº§ï¼šåŸå§‹ cron è¡¨è¾¾å¼ï¼ˆä¼˜å…ˆçº§é«˜äºä¸Šè¿°é…ç½®ï¼‰
  cron?: string; // "0 9 * * *"
}
```

### 10.2 next_run_at è®¡ç®—

å½“å‘¨æœŸä»»åŠ¡åˆ›å»ºæˆ–æŸæ¬¡æ‰§è¡Œå®Œæˆæ—¶ï¼Œæ ¹æ® `scheduleConfig` é‡æ–°è®¡ç®— `next_run_at`ã€‚task-worker é€šè¿‡æ‰«æ `next_run_at <= NOW()` æ¥è§¦å‘æ‰§è¡Œã€‚

## 11. ä¸ç°æœ‰ç³»ç»Ÿçš„å…³ç³»

| ç°æœ‰ç»„ä»¶           | å…³ç³»                                                                                                             |
| ------------------ | ---------------------------------------------------------------------------------------------------------------- |
| `tracker_tasks` è¡¨ | ç°æœ‰é€šç”¨ä»»åŠ¡è¿½è¸ªå™¨ã€‚Tasks æ¨¡å—ä½¿ç”¨**ç‹¬ç«‹çš„è¡¨**ï¼ˆ`task_*`ï¼‰ï¼Œå› ä¸ºè¯­ä¹‰ä¸åŒã€‚`tracker_tasks` ç»§ç»­ç”¨äºå…¶ä»–å†…éƒ¨è¿½è¸ªã€‚ |
| `im_bots`          | ä»»åŠ¡æ‰§è¡Œè€…ï¼Œé€šè¿‡ `task_tasks.bot_id` å…³è”                                                                        |
| `im_channels`      | æ‰©å±• `task` é¢‘é“ç±»å‹ï¼Œç”¨äºæ¯æ¬¡æ‰§è¡Œçš„ä¸“å±é€šä¿¡                                                                     |
| `im_users`         | ä»»åŠ¡åˆ›å»ºè€…ï¼Œé€šè¿‡ `task_tasks.creator_id` å…³è”                                                                    |
| `im-worker`        | ä¸å˜ã€‚ä»»åŠ¡è°ƒåº¦ç”±æ–°çš„ `task-worker` æœåŠ¡å¤„ç†                                                                      |
| WebSocket Gateway  | å¤ç”¨ç°æœ‰ Socket.io åŸºç¡€è®¾æ–½ï¼Œæ–°å¢ `task:*` äº‹ä»¶                                                                  |
| æ–‡ä»¶æ¨¡å— / å­˜å‚¨    | äº¤ä»˜ç‰©æ–‡ä»¶é€šè¿‡ç°æœ‰å­˜å‚¨åŸºç¡€è®¾æ–½ä¿å­˜                                                                               |
| OpenClaw æ¨¡å—      | `task-worker` è°ƒç”¨ OpenClaw API è§¦å‘ Agent æ‰§è¡Œ                                                                  |
| Bot Access Token   | Bot API æ¥å£é€šè¿‡ç°æœ‰ `t9bot_` Token æœºåˆ¶è®¤è¯                                                                     |

## 12. Gateway æ¨¡å—ç»“æ„

```
apps/server/apps/gateway/src/
â”œâ”€â”€ tasks/
â”‚   â”œâ”€â”€ tasks.module.ts
â”‚   â”œâ”€â”€ tasks.controller.ts            -- é¢å‘ç”¨æˆ·çš„ä»»åŠ¡ CRUD ä¸æ§åˆ¶
â”‚   â”œâ”€â”€ tasks.service.ts               -- ä»»åŠ¡ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ task-bot.controller.ts         -- é¢å‘ Bot çš„ APIï¼ˆaccess token è®¤è¯ï¼‰
â”‚   â”œâ”€â”€ task-bot.service.ts            -- Bot API ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ task-execution.service.ts      -- æ‰§è¡Œç®¡ç†
â”‚   â”œâ”€â”€ task-intervention.service.ts   -- å¹²é¢„ç®¡ç†
â”‚   â”œâ”€â”€ task-deliverable.service.ts    -- äº¤ä»˜ç‰©ç®¡ç†
â”‚   â””â”€â”€ dto/
â”‚       â”œâ”€â”€ create-task.dto.ts
â”‚       â”œâ”€â”€ update-task.dto.ts
â”‚       â”œâ”€â”€ task-control.dto.ts
â”‚       â”œâ”€â”€ report-steps.dto.ts
â”‚       â”œâ”€â”€ create-intervention.dto.ts
â”‚       â””â”€â”€ resolve-intervention.dto.ts
â”œâ”€â”€ documents/
â”‚   â”œâ”€â”€ documents.module.ts
â”‚   â”œâ”€â”€ documents.controller.ts
â”‚   â””â”€â”€ documents.service.ts
```

## 13. æ•°æ®åº“ Schema ç»“æ„

```
apps/server/libs/database/src/schemas/
â”œâ”€â”€ im/          ï¼ˆç°æœ‰ï¼‰
â”œâ”€â”€ tenant/      ï¼ˆç°æœ‰ï¼‰
â”œâ”€â”€ tracker/     ï¼ˆç°æœ‰ï¼‰
â”œâ”€â”€ task/        ï¼ˆæ–°å¢ï¼‰
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ tasks.ts
â”‚   â”œâ”€â”€ task-executions.ts
â”‚   â”œâ”€â”€ task-steps.ts
â”‚   â”œâ”€â”€ task-deliverables.ts
â”‚   â”œâ”€â”€ task-interventions.ts
â”‚   â””â”€â”€ relations.ts
â””â”€â”€ document/    ï¼ˆæ–°å¢ï¼‰
    â”œâ”€â”€ index.ts
    â”œâ”€â”€ documents.ts
    â”œâ”€â”€ document-versions.ts
    â””â”€â”€ relations.ts
```

## 14. å®æ–½é˜¶æ®µï¼ˆå»ºè®®ï¼‰

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€æ­å»º

- [ ] æ•°æ®åº“ Schemaï¼ˆtask/, document/ï¼‰
- [ ] æ–‡æ¡£æ¨¡å—ï¼ˆCRUD + ç‰ˆæœ¬ç®¡ç†ï¼‰
- [ ] ä»»åŠ¡ CRUD APIï¼ˆGatewayï¼‰
- [ ] åŸºç¡€ä»»åŠ¡åˆ—è¡¨ UIï¼ˆTask List Tabï¼Œå¡ç‰‡å±•ç¤ºï¼‰

### ç¬¬äºŒé˜¶æ®µï¼šæ‰§è¡Œå¼•æ“

- [ ] task-worker æœåŠ¡è„šæ‰‹æ¶
- [ ] æ‰§è¡Œç”Ÿå‘½å‘¨æœŸï¼ˆåˆ›å»ºæ‰§è¡Œè®°å½•ã€åˆ›å»ºä»»åŠ¡é¢‘é“ï¼‰
- [ ] OpenClaw æ‰§è¡Œç­–ç•¥é›†æˆ
- [ ] Bot API æ¥å£ï¼ˆçŠ¶æ€æ±‡æŠ¥ã€æ­¥éª¤æ›´æ–°ï¼‰
- [ ] WebSocket å®æ—¶æ›´æ–°äº‹ä»¶

### ç¬¬ä¸‰é˜¶æ®µï¼šäº¤äº’åŠŸèƒ½

- [ ] ä»»åŠ¡æ§åˆ¶ï¼ˆå¯åŠ¨ã€æš‚åœã€æ¢å¤ã€åœæ­¢ã€é‡æ–°æ‰§è¡Œï¼‰
- [ ] å¹²é¢„ç³»ç»Ÿï¼ˆå‘èµ·è¯·æ±‚ + ç”¨æˆ·å“åº”ï¼‰
- [ ] ä»»åŠ¡è¯¦æƒ…é¢æ¿ UIï¼ˆæ­¥éª¤æ—¶é—´çº¿ã€å¹²é¢„äº¤äº’ï¼‰
- [ ] è¯¦æƒ…é¢æ¿æ¶ˆæ¯è¾“å…¥æ¡†ï¼ˆä»»åŠ¡é¢‘é“é›†æˆï¼‰

### ç¬¬å››é˜¶æ®µï¼šè°ƒåº¦ä¸äº¤ä»˜ç‰©

- [ ] task-worker ä¸­çš„å‘¨æœŸä»»åŠ¡è°ƒåº¦å™¨
- [ ] è°ƒåº¦é…ç½® UI
- [ ] äº¤ä»˜ç‰©ä¸Šä¼ ä¸å±•ç¤º
- [ ] å·²å®Œæˆä»»åŠ¡è§†å›¾ï¼ˆå«äº¤ä»˜ç‰©åˆ—è¡¨ï¼‰

### ç¬¬äº”é˜¶æ®µï¼šå®Œå–„

- [ ] è¶…æ—¶æ£€æµ‹
- [ ] é”™è¯¯å¤„ç†ä¸é‡è¯•
- [ ] Token ç”¨é‡ç»Ÿè®¡ä¸å±•ç¤º
- [ ] æ–‡æ¡£ç‰ˆæœ¬å†å² UI
